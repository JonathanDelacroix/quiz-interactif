"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Multiplexor = void 0;
/**
 * Util for pack multiple requests to one
 *
 * It's just encode/decode all texts with custom separation options
 */
var Multiplexor = exports.Multiplexor = /** @class */function () {
  // private readonly token: Array<Array<string>> = [];
  function Multiplexor(options) {
    this.options = {
      tokenStart: '<',
      tokenEnd: '>',
      tokenClose: '/'
    };
    if (options !== undefined) {
      ['tokenStart', 'tokenEnd', 'tokenClose'].forEach(function (key) {
        var item = options[key];
        if (item !== undefined && item.search(/\&|\:/) !== -1) {
          throw new Error("Option ".concat(key, " has disallow characters (& or :)"));
        }
      });
      for (var key in options) {
        this.options[key] = options[key];
      }
    }
  }
  Multiplexor.prototype.encode = function (data) {
    var _this = this;
    var _a = this.options,
      _b = _a.tokenStart,
      start = _b === void 0 ? '' : _b,
      _c = _a.tokenEnd,
      end = _c === void 0 ? '' : _c,
      _d = _a.tokenClose,
      close = _d === void 0 ? '' : _d;
    return data.map(function (_a) {
      var id = _a.id,
        text = _a.text;
      return start + id + end + _this.escape(text) + start + close + id + end;
    }).join(' ');
  };
  Multiplexor.prototype.decode = function (text) {
    var _a = this.options,
      _b = _a.tokenStart,
      start = _b === void 0 ? '' : _b,
      _c = _a.tokenEnd,
      end = _c === void 0 ? '' : _c,
      _d = _a.tokenClose,
      close = _d === void 0 ? '' : _d;
    var pattern = "".concat(start, "\\s*(\\d+)\\s*").concat(end, "([\\w\\W]+?)").concat(start, "\\s*").concat(close, "\\s*\\1\\s*").concat(end);
    var matchSet = text.matchAll(new RegExp(pattern, 'gm'));
    var result = [];
    var match = matchSet.next();
    while (!match.done) {
      result.push({
        id: match.value[1],
        text: this.unescape(match.value[2])
      });
      match = matchSet.next();
    }
    return result;
  };
  Multiplexor.prototype.escape = function (text) {
    var _this = this;
    ['tokenStart', 'tokenEnd', 'tokenClose'].forEach(function (key, index) {
      var token = _this.options[key];
      if (token.length > 0) {
        text = text.replace(new RegExp(_this.escapeRegExp(token), 'g'), "&".concat(index + 1, ":"));
      }
    });
    return text;
  };
  Multiplexor.prototype.unescape = function (text) {
    var _this = this;
    ['tokenStart', 'tokenEnd', 'tokenClose'].forEach(function (key, index) {
      var token = _this.options[key];
      if (token.length > 0) {
        text = text.replace(new RegExp("&".concat(index + 1, ":"), 'g'), token);
      }
    });
    return text;
  };
  Multiplexor.prototype.escapeRegExp = function (text) {
    return text.replace(/[-[\]{}()*+?.,\\^$|#\s]/g, '\\$&');
  };
  return Multiplexor;
}();
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbHMvTXVsdGlwbGV4b3IuanMiLCJuYW1lcyI6WyJNdWx0aXBsZXhvciIsImV4cG9ydHMiLCJvcHRpb25zIiwidG9rZW5TdGFydCIsInRva2VuRW5kIiwidG9rZW5DbG9zZSIsInVuZGVmaW5lZCIsImZvckVhY2giLCJrZXkiLCJpdGVtIiwic2VhcmNoIiwiRXJyb3IiLCJjb25jYXQiLCJwcm90b3R5cGUiLCJlbmNvZGUiLCJkYXRhIiwiX3RoaXMiLCJfYSIsIl9iIiwic3RhcnQiLCJfYyIsImVuZCIsIl9kIiwiY2xvc2UiLCJtYXAiLCJpZCIsInRleHQiLCJlc2NhcGUiLCJqb2luIiwiZGVjb2RlIiwicGF0dGVybiIsIm1hdGNoU2V0IiwibWF0Y2hBbGwiLCJSZWdFeHAiLCJyZXN1bHQiLCJtYXRjaCIsIm5leHQiLCJkb25lIiwicHVzaCIsInZhbHVlIiwidW5lc2NhcGUiLCJpbmRleCIsInRva2VuIiwibGVuZ3RoIiwicmVwbGFjZSIsImVzY2FwZVJlZ0V4cCJdLCJzb3VyY2VzIjpbInV0aWxzL011bHRpcGxleG9yLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImludGVyZmFjZSBPcHRpb25zIHtcblx0dG9rZW5TdGFydD86IHN0cmluZztcblx0dG9rZW5FbmQ/OiBzdHJpbmc7XG5cdHRva2VuQ2xvc2U/OiBzdHJpbmc7XG59XG5cbmludGVyZmFjZSBUZXh0Q29udGFpbmVyIHtcblx0aWQ6IHN0cmluZztcblx0dGV4dDogc3RyaW5nO1xufVxuXG4vKipcbiAqIFV0aWwgZm9yIHBhY2sgbXVsdGlwbGUgcmVxdWVzdHMgdG8gb25lXG4gKlxuICogSXQncyBqdXN0IGVuY29kZS9kZWNvZGUgYWxsIHRleHRzIHdpdGggY3VzdG9tIHNlcGFyYXRpb24gb3B0aW9uc1xuICovXG5leHBvcnQgY2xhc3MgTXVsdGlwbGV4b3Ige1xuXHRwcml2YXRlIHJlYWRvbmx5IG9wdGlvbnM6IE9wdGlvbnMgPSB7XG5cdFx0dG9rZW5TdGFydDogJzwnLFxuXHRcdHRva2VuRW5kOiAnPicsXG5cdFx0dG9rZW5DbG9zZTogJy8nLFxuXHR9O1xuXG5cdC8vIHByaXZhdGUgcmVhZG9ubHkgdG9rZW46IEFycmF5PEFycmF5PHN0cmluZz4+ID0gW107XG5cdGNvbnN0cnVjdG9yKG9wdGlvbnM/OiBPcHRpb25zKSB7XG5cdFx0aWYgKG9wdGlvbnMgIT09IHVuZGVmaW5lZCkge1xuXHRcdFx0Wyd0b2tlblN0YXJ0JywgJ3Rva2VuRW5kJywgJ3Rva2VuQ2xvc2UnXS5mb3JFYWNoKChrZXkpID0+IHtcblx0XHRcdFx0Y29uc3QgaXRlbSA9IChvcHRpb25zIGFzIGFueSlba2V5XTtcblx0XHRcdFx0aWYgKGl0ZW0gIT09IHVuZGVmaW5lZCAmJiBpdGVtLnNlYXJjaCgvXFwmfFxcOi8pICE9PSAtMSkge1xuXHRcdFx0XHRcdHRocm93IG5ldyBFcnJvcihgT3B0aW9uICR7a2V5fSBoYXMgZGlzYWxsb3cgY2hhcmFjdGVycyAoJiBvciA6KWApO1xuXHRcdFx0XHR9XG5cdFx0XHR9KTtcblxuXHRcdFx0Zm9yIChjb25zdCBrZXkgaW4gb3B0aW9ucykge1xuXHRcdFx0XHQodGhpcy5vcHRpb25zIGFzIGFueSlba2V5XSA9IChvcHRpb25zIGFzIGFueSlba2V5XTtcblx0XHRcdH1cblx0XHR9XG5cdH1cblxuXHRwdWJsaWMgZW5jb2RlKGRhdGE6IFRleHRDb250YWluZXJbXSkge1xuXHRcdGNvbnN0IHtcblx0XHRcdHRva2VuU3RhcnQ6IHN0YXJ0ID0gJycsXG5cdFx0XHR0b2tlbkVuZDogZW5kID0gJycsXG5cdFx0XHR0b2tlbkNsb3NlOiBjbG9zZSA9ICcnLFxuXHRcdH0gPSB0aGlzLm9wdGlvbnM7XG5cblx0XHRyZXR1cm4gZGF0YVxuXHRcdFx0Lm1hcChcblx0XHRcdFx0KHsgaWQsIHRleHQgfSkgPT5cblx0XHRcdFx0XHRzdGFydCArIGlkICsgZW5kICsgdGhpcy5lc2NhcGUodGV4dCkgKyBzdGFydCArIGNsb3NlICsgaWQgKyBlbmQsXG5cdFx0XHQpXG5cdFx0XHQuam9pbignICcpO1xuXHR9XG5cblx0cHVibGljIGRlY29kZSh0ZXh0OiBzdHJpbmcpIHtcblx0XHRjb25zdCB7XG5cdFx0XHR0b2tlblN0YXJ0OiBzdGFydCA9ICcnLFxuXHRcdFx0dG9rZW5FbmQ6IGVuZCA9ICcnLFxuXHRcdFx0dG9rZW5DbG9zZTogY2xvc2UgPSAnJyxcblx0XHR9ID0gdGhpcy5vcHRpb25zO1xuXG5cdFx0Y29uc3QgcGF0dGVybiA9IGAke3N0YXJ0fVxcXFxzKihcXFxcZCspXFxcXHMqJHtlbmR9KFtcXFxcd1xcXFxXXSs/KSR7c3RhcnR9XFxcXHMqJHtjbG9zZX1cXFxccypcXFxcMVxcXFxzKiR7ZW5kfWA7XG5cdFx0Y29uc3QgbWF0Y2hTZXQgPSB0ZXh0Lm1hdGNoQWxsKG5ldyBSZWdFeHAocGF0dGVybiwgJ2dtJykpO1xuXG5cdFx0Y29uc3QgcmVzdWx0ID0gW107XG5cdFx0bGV0IG1hdGNoID0gbWF0Y2hTZXQubmV4dCgpO1xuXHRcdHdoaWxlICghbWF0Y2guZG9uZSkge1xuXHRcdFx0cmVzdWx0LnB1c2goe1xuXHRcdFx0XHRpZDogbWF0Y2gudmFsdWVbMV0sXG5cdFx0XHRcdHRleHQ6IHRoaXMudW5lc2NhcGUobWF0Y2gudmFsdWVbMl0pLFxuXHRcdFx0fSk7XG5cdFx0XHRtYXRjaCA9IG1hdGNoU2V0Lm5leHQoKTtcblx0XHR9XG5cblx0XHRyZXR1cm4gcmVzdWx0O1xuXHR9XG5cblx0cHJpdmF0ZSBlc2NhcGUodGV4dDogc3RyaW5nKSB7XG5cdFx0Wyd0b2tlblN0YXJ0JywgJ3Rva2VuRW5kJywgJ3Rva2VuQ2xvc2UnXS5mb3JFYWNoKChrZXksIGluZGV4KSA9PiB7XG5cdFx0XHRjb25zdCB0b2tlbiA9ICh0aGlzLm9wdGlvbnMgYXMgYW55KVtrZXldO1xuXHRcdFx0aWYgKHRva2VuLmxlbmd0aCA+IDApIHtcblx0XHRcdFx0dGV4dCA9IHRleHQucmVwbGFjZShcblx0XHRcdFx0XHRuZXcgUmVnRXhwKHRoaXMuZXNjYXBlUmVnRXhwKHRva2VuKSwgJ2cnKSxcblx0XHRcdFx0XHRgJiR7aW5kZXggKyAxfTpgLFxuXHRcdFx0XHQpO1xuXHRcdFx0fVxuXHRcdH0pO1xuXG5cdFx0cmV0dXJuIHRleHQ7XG5cdH1cblxuXHRwcml2YXRlIHVuZXNjYXBlKHRleHQ6IHN0cmluZykge1xuXHRcdFsndG9rZW5TdGFydCcsICd0b2tlbkVuZCcsICd0b2tlbkNsb3NlJ10uZm9yRWFjaCgoa2V5LCBpbmRleCkgPT4ge1xuXHRcdFx0Y29uc3QgdG9rZW4gPSAodGhpcy5vcHRpb25zIGFzIGFueSlba2V5XTtcblx0XHRcdGlmICh0b2tlbi5sZW5ndGggPiAwKSB7XG5cdFx0XHRcdHRleHQgPSB0ZXh0LnJlcGxhY2UobmV3IFJlZ0V4cChgJiR7aW5kZXggKyAxfTpgLCAnZycpLCB0b2tlbik7XG5cdFx0XHR9XG5cdFx0fSk7XG5cblx0XHRyZXR1cm4gdGV4dDtcblx0fVxuXG5cdHByaXZhdGUgZXNjYXBlUmVnRXhwKHRleHQ6IHN0cmluZykge1xuXHRcdHJldHVybiB0ZXh0LnJlcGxhY2UoL1stW1xcXXt9KCkqKz8uLFxcXFxeJHwjXFxzXS9nLCAnXFxcXCQmJyk7XG5cdH1cbn1cbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBV0E7Ozs7O0FBS0EsSUFBQUEsV0FBQSxHQUFBQyxPQUFBLENBQUFELFdBQUE7RUFPQztFQUNBLFNBQUFBLFlBQVlFLE9BQWlCO0lBUFosS0FBQUEsT0FBTyxHQUFZO01BQ25DQyxVQUFVLEVBQUUsR0FBRztNQUNmQyxRQUFRLEVBQUUsR0FBRztNQUNiQyxVQUFVLEVBQUU7S0FDWjtJQUlBLElBQUlILE9BQU8sS0FBS0ksU0FBUyxFQUFFO01BQzFCLENBQUMsWUFBWSxFQUFFLFVBQVUsRUFBRSxZQUFZLENBQUMsQ0FBQ0MsT0FBTyxDQUFDLFVBQUNDLEdBQUc7UUFDcEQsSUFBTUMsSUFBSSxHQUFJUCxPQUFlLENBQUNNLEdBQUcsQ0FBQztRQUNsQyxJQUFJQyxJQUFJLEtBQUtILFNBQVMsSUFBSUcsSUFBSSxDQUFDQyxNQUFNLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUU7VUFDdEQs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
